#!/bin/sh
#
# Perform maintainance functionality for api-server and web-client to the e2e
# test suite.

function help() {
  echo "+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+="
  echo ""
  echo " jazz       ((::.. ü§ñ  ..::)) "
  echo ""
  echo " jazz is your robot friend for e2e tests "
  echo ""
  echo "------------------------------------------------------------------------"
  echo ""
  echo "TESTING ‚úÖ"
  echo " test [option]      - run [all] tests or a specific suite, eg. 'courses'"
  echo ""
  echo "MAINTENANCE üõ†"
  echo " update [option]    - pull new code from [webclient/apiserver/both] "
  echo " ignitedb           - starts the db "
  echo " resetdb            - resets the db "
  echo " build              - builds the web-client "
  echo " shiny              - all of the above "
  echo " e2e [branch]       - pushes latest [branch] to e2e.edvisor.io "
  echo ""
  echo "+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+="
}

function err() {
  echo "[$(date +'%Y-%m-%dT%H:%M:%S%z')]: $@" >&2
}

function update_e2e() {
  echo ""
  echo " üöÄ pushing the $1 branch to e2e.edvisor.io "
  echo ""
  cd /Users/Beastie/development/edvisorio/web-client && git checkout $1 && git pull --rebase && git push origin origin/$1:e2e -f && git checkout -
  cd /Users/Beastie/development/edvisorio/api-server && git checkout $1 && git pull --rebase && git push origin origin/$1:e2e -f && git checkout -
}

function run_all_suites() {
  echo ""
  echo " ‚úÖ TESTING ALL THE THINGS"
  echo "                    --- ü§ñ"
  echo ""
  cd /Users/Beastie/development/edvisorio/web-client-e2e && LM=true ./node_modules/protractor/bin/protractor protractor.conf.js
  woohoo
}

function run_suite() {
  echo ""
  echo " ‚úÖ TESTING with the $1 suite"
  echo "                    --- ü§ñ"
  echo ""
  cd /Users/Beastie/development/edvisorio/web-client-e2e && CI=true CIRCLE_BRANCH='master' LM=true ./node_modules/protractor/bin/protractor protractor.conf.js --suite $1
  woohoo
}

function ignitedb () {
  echo ""
  echo " üõ† database starting "
  echo "         --- ü§ñ "
  mysql.server start
  woohoo
}

function resetdb () {
  echo " üå™ turning back time --- ü§ñ"
  cd /Users/Beastie/development/edvisorio/api-server && ./bin/edvisor full-reset
  woohoo
}

function pullwebclient () {
  echo " ‚ö°Ô∏è jazzing up your web-client."
  cd /Users/Beastie/development/edvisorio/web-client && git pull --rebase && npm install
  woohoo
}

function pullapiserver () {
  echo " ‚ö°Ô∏è jazzing up your api-server."
  cd /Users/Beastie/development/edvisorio/api-server && git pull --rebase && npm install
  woohoo
}

function buildclient () {
  echo " üõ† building client."
  cd /Users/Beastie/development/edvisorio/api-server && ./bin/edvisor build -s client
  woohoo
}

function woohoo () {
  echo ""
  echo " ‚ú® ALL DONE! ‚ú® "
  echo ""
}

function woops () {
  echo ""
  err " üö´ woops, can't do that üö´ "
  exit "${1}"
  echo ""
}

if [ $1 ]
then
  case "$1" in
  test)
    if [ $2 ] ; then
      case "$2" in
      all)
        run_all_suites
        ;;
      *)
        run_suite $2
        ;;
      esac
    else
      woops
      help
      exit 1
    fi
    ;;
  update)
    if [ $2 ] ; then
      case "$2" in
      webclient)
        pullwebclient
        ;;
      apiserver)
        pullapiserver
        ;;
      both)
        pullwebclient
        pullapiserver
        ;;
      *)
        woops
        help
        ;;
      esac
    else
      help
    fi
    ;;
  resetdb)
    resetdb
    ;;
  ignitedb)
    ignitedb
    ;;
  buildclient)
    buildclient
    ;;
  shiny)
    pullwebclient
    pullapiserver
    ignitedb
    resetdb
    buildclient
    ;;
  e2e)
    if [ $2 ] ; then
      update_e2e $2
    else
      woops
      help
    fi
    ;;
  *)
    woops
    help
    ;;
  esac
else
  help
  exit 0
fi
